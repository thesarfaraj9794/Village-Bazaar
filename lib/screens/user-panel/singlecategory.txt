import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';

import 'package:village_bazzar/models/product-model.dart';
import 'package:village_bazzar/screens/user-panel/product-details-screen.dart';

class AllSingleCategoryProductsScreen extends StatefulWidget {
  final String categoryId;

  const AllSingleCategoryProductsScreen({
    super.key,
    required this.categoryId,
  });

  @override
  State<AllSingleCategoryProductsScreen> createState() =>
      _AllSingleCategoryProductsScreenState();
}

class _AllSingleCategoryProductsScreenState
    extends State<AllSingleCategoryProductsScreen> {

  /// Responsive cross axis count
  int getCrossAxisCount(BuildContext context) {
    double width = MediaQuery.of(context).size.width;

    if (width < 500) return 2;     // Mobile
    if (width < 900) return 3;     // Small Tablet
    if (width < 1200) return 4;    // Large Tablet
    return 5;                      // Desktop / Web
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor:  const Color.fromARGB(255, 192, 198, 206),
      appBar: AppBar(
        backgroundColor:  const Color.fromARGB(255, 192, 198, 206),
        title: const Text(
          'Products ',
          style: TextStyle(color: Colors.black),
        ),
        centerTitle: true,
      ),

      body: FutureBuilder(
        future: FirebaseFirestore.instance
            .collection('products')
            .where('categoryId', isEqualTo: widget.categoryId)
            .get(),

        builder: (context, AsyncSnapshot<QuerySnapshot> snapshot) {
          
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CupertinoActivityIndicator());
          }

          if (snapshot.hasError) {
            return const Center(child: Text("Error loading products"));
          }

          if (snapshot.data!.docs.isEmpty) {
            return const Center(child: Text("No products found"));
          }

          return GridView.builder(
            padding: const EdgeInsets.all(10),
            itemCount: snapshot.data!.docs.length,

            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: getCrossAxisCount(context),
              crossAxisSpacing: 10,
              mainAxisSpacing: 10,
              childAspectRatio: 0.70,
            ),

            itemBuilder: (context, index) {
              final data = snapshot.data!.docs[index];

              ProductModel productModel = ProductModel(
                productId: data['productId'],
                categoryId: data['categoryId'],
                productName: data['productName'],
                categoryName: data['categoryName'],
                salePrice: data['salePrice'],
                fullPrice: data['fullPrice'],
                productImages: data['productImages'],
                deliveryTime: data['deliveryTime'],
                isSale: data['isSale'],
                isGram: data['isGram'],
                productDescription: data['productDescription'],
                createdAt: data['createdAt'],
                updatedAt: data['updatedAt'],
                // isGramProduct: data['isGramProduct'],

                

              );

              return GestureDetector(
                onTap: () {
                  Get.to(() =>
                      ProductDetailsScreen(productModel: productModel));
                },

                child: ProductCard(productModel: productModel),
              );
            },
          );
        },
      ),
    );
  }
}

/// -------------------------------------
/// Product Card Widget
/// -------------------------------------

class ProductCard extends StatelessWidget {
  final ProductModel productModel;

  const ProductCard({super.key, required this.productModel});

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(15),
      ),

      child: ClipRRect(
        borderRadius: BorderRadius.circular(15),

        child: Stack(
          children: [
            /// PRODUCT IMAGE
            CachedNetworkImage(
              imageUrl: productModel.productImages[0],
              width: double.infinity,
              height: double.infinity,
              fit: BoxFit.cover,
            ),

            /// PRODUCT NAME + PRICE (BOTTOM BLUE OVERLAY)
            Positioned(
              bottom: 0,
              left: 0,
              right: 0,

              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 4),
                color: Colors.blue.withOpacity(0.85),

                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      productModel.productName,
                      overflow: TextOverflow.ellipsis,
                      textAlign: TextAlign.center,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),

                    const SizedBox(height: 2),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        // Text(
                        //   "Rs ${productModel.salePrice}",
                        //   style: const TextStyle(
                        //     color: Colors.white,
                        //     fontSize: 12,
                        //     fontWeight: FontWeight.bold,
                        //   ),
                        // ),
                        const SizedBox(width: 5),
                        // Text(
                        //   "${productModel.fullPrice}",
                        //   style: const TextStyle(
                        //     color: Colors.red,
                        //     fontSize: 12,
                        //     decoration: TextDecoration.lineThrough,
                        //   ),
                        // ),
                      ],
                    ),
                   ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
